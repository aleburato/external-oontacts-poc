var E=Object.defineProperty;var D=(n,t,a)=>t in n?E(n,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[t]=a;var u=(n,t,a)=>D(n,typeof t!="symbol"?t+"":t,a);import{D as L,r as c,u as y,j as s,a as b,c as O}from"./vendor-YCrArcGf.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))o(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function a(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(e){if(e.ep)return;e.ep=!0;const r=a(e);fetch(e.href,r)}})();function N(n){return n[Math.floor(Math.random()*n.length)]}function k(){return N(["work","mobile","other"])}function A(){return N(["Gerhold Inc","Dibbert Group","Hane, Dicki and Borer","Fritsch LLC","Shields, Beatty and Zemlak","Jaskolski, Luettgen and Zieme","Hoeger Group","Bins, Rice and Friesen","Toy, Morissette and Bartell","Larson and Sons","Wisozk, O'Keefe and Wolff","Von-Kreiger","Nolan, Volkman and Nader","Erdman-Wehner","Beatty Inc","Cremin PLC","Douglas, Bailey and Gutkowski","Quitzon LLC","Batz and Sons","Bode Inc","Douglas-Schneider","Powlowski, Lowe and Beer","Kshlerin, Pagac and Hodkiewicz","Connelly and Sons","Smitham Ltd","Crooks PLC","Goldner PLC","Corkery, Hodkiewicz and Huels","Kovacek Inc","Von-Marvin","Gibson, Block and Dooley","Flatley-Bernier","Schumm Inc","Ziemann PLC","Mayer Ltd","Okuneva, Parisian and Sporer","Greenholt, Bradtke and Huel","Medhurst and Sons","Hermiston-Reichel","Spencer, Bins and Thompson","Raynor Inc","Koelpin Group","Schaden Group","Maggio-Ernser","Goodwin, Howe and Stamm","O'Connell, Greenfelder and Feest","Schneider, Marquardt and Beier","D'Amore-Cormier","Wunsch-Hamill","Homenick Group"])}class M{constructor(t,a){u(this,"getTotalContactsCount",async()=>(await this.getExternalContacts({start:0,limit:1})).total);u(this,"getExternalContacts",async({start:t,limit:a})=>{const o=new URLSearchParams({start:`${t}`,limit:`${a}`}),r=await(await fetch(`https://webexapis.com/v1/contacts/organizations/${this.orgId}/contacts/search?${o}`,{method:"GET",headers:{Authorization:`Bearer ${this._authToken}`}})).json(),l=r.result;return{start:r.start,contacts:l.map(i=>{var d;return{id:i.contactId,givenName:i.firstName,familyName:i.lastName,displayName:`${i.firstName} ${i.lastName}`,companyName:A(),phoneNumbers:((d=i.phoneNumbers)==null?void 0:d.map(m=>`${m.value};${k()}`))||[]}}),total:r.total,limit:r.limit}});this.orgId=t,this._authToken=a}}let x;function B(){return x||(x=new M("1f11209c-7b1d-4ffc-8179-dabb90e2fb79","MGE3YTY2MDMtZmI5Zi00Zjg0LTliMGItMjU3NmUzNTk4OThmMDI0MzdlMjUtZDFj_P0A1_1f11209c-7b1d-4ffc-8179-dabb90e2fb79")),x}const f=new L("ExternalContactsDatabase");f.version(1).stores({contacts:"id, displayName, companyName, givenName, familyName, *phoneNumbers",meta:""});class T{constructor(t){u(this,"clearDb",async({lastRetrievedApiTotal:t,orgId:a})=>{await this.db.contacts.clear(),await this.db.meta.put({orgId:a,lastRetrievedApiTotal:t,nextContactOffset:0,failedContactInsertionAttempts:0,timestamp:new Date().toISOString()},"lastMeta")});u(this,"getImportStatus",async()=>await this.db.transaction("r",[this.db.contacts,this.db.meta],async()=>{const t=await this.db.meta.get("lastMeta");return{orgId:(t==null?void 0:t.orgId)||"",lastRetrievedApiTotal:(t==null?void 0:t.lastRetrievedApiTotal)??-1,contactsCount:await this.db.contacts.count(),nextOffset:(t==null?void 0:t.nextContactOffset)??0,insertionErrors:(t==null?void 0:t.failedContactInsertionAttempts)??0}}));u(this,"addContacts",async t=>{await this.db.transaction("rw",[this.db.contacts,this.db.meta],async()=>{var a,o;try{await this.db.contacts.bulkAdd(t)}catch(e){if((e==null?void 0:e.name)==="BulkError"){const r=e,l=((a=await this.db.meta.get("lastMeta"))==null?void 0:a.failedContactInsertionAttempts)||0;await this.db.meta.update("lastMeta",{failedContactInsertionAttempts:l+((o=r.failures)==null?void 0:o.length)||0}),this.logBulkError(r)}}})});u(this,"queryContacts",async({search:t,limit:a,start:o})=>{const e=this.db.contacts,r=t?e.where("displayName").startsWithIgnoreCase(t).or("companyName").startsWithIgnoreCase(t).or("givenName").startsWithIgnoreCase(t).or("familyName").startsWithIgnoreCase(t).or("phoneNumbers").startsWithIgnoreCase(t).distinct():e.toCollection(),l=new Set(await r.primaryKeys()),i=[];let d=0;return await e.orderBy("givenName").until(()=>i.length>=a).eachPrimaryKey(m=>{l.has(m)&&(d>=o?i.push(e.get(m)):d++)}),{contacts:await Promise.all(i),totalContacts:l.size}});u(this,"updateNextOffset",async t=>{await this.db.meta.update("lastMeta",{nextContactOffset:t})});u(this,"logBulkError",t=>{var a,o;try{console.error(((a=t.failures)==null?void 0:a.length)+" insertions failed!"),(o=t.failures)==null||o.forEach(e=>{console.error(e.message)});for(const[e,r]of Object.entries(t.failuresByPos))console.error(`Operation ${e} failed with ${r}`)}catch{}});this.db=t}}let C;function j(n=f){return C||(C=new T(n)),C}const G=1e3,$=5e4;async function R({_dbRepo:n,_contactsApi:t,_pageSize:a}={_dbRepo:j(),_contactsApi:B(),_pageSize:$}){console.log(">>> resumeOrStartPopulatingDb: BEGIN");const o=await t.getTotalContactsCount(),e=t.orgId,{lastRetrievedApiTotal:r,orgId:l}=await n.getImportStatus();(r!==o||l!==e)&&(console.log(">>> resumeOrStartPopulatingDb: clearing DB for API/DB mismatch",{lastRetrievedApiTotal:r,apiTotal:o,orgId:l,currentOrgId:e}),await n.clearDb({lastRetrievedApiTotal:o,orgId:e}));let i=0;for(;;){if(++i>G)throw new Error("Max number of calls exceeded");const{contactsCount:d,insertionErrors:m,nextOffset:h}=await n.getImportStatus();if(console.log(`>>> resumeOrStartPopulatingDb (${i}): `,{apiTotal:o,contactsCount:d,insertionErrors:m,nextOffset:h}),h>=o){console.log(`>>> resumeOrStartPopulatingDb (${i}): offset exceeded total, ${d}/${o} contacts have been ingested`,{contactsCount:d,apiTotal:o,nextOffset:h});break}const p=await t.getExternalContacts({limit:a,start:h});console.log(`>>> resumeOrStartPopulatingDb (${i}), called getExternalContacts: `,{limit:a,start:h},p),await n.addContacts(p.contacts),console.log(`>>> resumeOrStartPopulatingDb (${i}), added contacts to repo`),await n.updateNextOffset(h+a)}console.log(">>> resumeOrStartPopulatingDb: OVER")}function H(){const n=c.useRef(!1),[t,a]=c.useState(!1);return c.useEffect(()=>{n.current||(n.current=!0,R().then(()=>{a(!0)}))},[]),t}function W(){return y(async()=>{const n=await f.contacts.count(),t=await f.meta.get("lastMeta");return t?{contactsCount:n,...t}:void 0})}function z({search:n,start:t,limit:a}){return y(async()=>({...await j().queryContacts({search:n,start:t,limit:a}),search:n}),[n,t,a],void 0)}const w=c.createContext({setMaxPage:()=>{}}),S=c.memo(({dbMeta:n,queryResults:t,searchTerm:a,page:o})=>{const e=(o-1)*g+1,r=Math.min(e+t.contacts.length-1,t.totalContacts),l=Math.ceil(t.totalContacts/g),{setMaxPage:i}=c.useContext(w);return c.useEffect(()=>{i(l)},[l,i]),s.jsxs("div",{className:"contactListHeaderWrapper",children:[s.jsxs("h3",{children:["Query results ",a?`matching '${a}'`:""," (",e,"...",r,"/ ",t.totalContacts,")"]}),s.jsxs("span",{children:["Last update: ",s.jsx("b",{children:new Date(n.timestamp).toLocaleString()}),". Total contacts stored in DB: ",s.jsx("b",{children:n.contactsCount})," / API: ",s.jsx("b",{children:n.lastRetrievedApiTotal})," (",s.jsxs("span",{className:"insertionErrors",children:[n.failedContactInsertionAttempts," errors"]}),")"]})]})});S.displayName="ContactListHeader";const I=c.memo(({startOffset:n,contacts:t})=>s.jsx("div",{className:"contactListTableWrapper",children:s.jsxs("table",{children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{className:"rightAlign",children:"#"}),s.jsx("th",{children:"Display Name"}),s.jsx("th",{children:"Given Name"}),s.jsx("th",{children:"Family Name"}),s.jsx("th",{children:"Company Name"}),s.jsx("th",{children:"Phone Numbers"}),s.jsx("th",{children:"Contact ID"})]},"thead")}),s.jsx("tbody",{children:t.map((a,o)=>s.jsxs("tr",{children:[s.jsx("td",{className:"rightAlign",children:n+o+1}),s.jsx("td",{children:a.displayName}),s.jsx("td",{children:a.givenName}),s.jsx("td",{children:a.familyName}),s.jsx("td",{children:a.companyName||""}),s.jsx("td",{children:a.phoneNumbers.map(e=>e.split(";")[0]).join(", ")}),s.jsx("td",{children:a.id})]},a.id))})]})}));I.displayName="ContactListTable";const g=1e3,P=c.memo(({searchTerm:n,page:t})=>{const a=W(),o=(t-1)*g,e=z({search:n,start:o,limit:g});return console.log(">>> render contacts list",e,n),s.jsxs("div",{className:"contactsListWrapper",children:[e&&a&&n===e.search?s.jsx(S,{dbMeta:a,queryResults:e,searchTerm:n,page:t}):s.jsx("h3",{children:"Loading..."}),(e==null?void 0:e.contacts)&&s.jsx(I,{contacts:e==null?void 0:e.contacts,startOffset:o})]})});P.displayName="ContactList";const v=c.memo(({onSearchChange:n,onPageChange:t,maxPage:a})=>{const[o,e]=c.useState(""),[r,l]=c.useState(1),i=b(o,300).trim(),d=b(r,300);c.useEffect(()=>{n(i)},[i,n]),c.useEffect(()=>{t(d)},[t,d]);const m=c.useCallback(p=>{e(p.target.value)},[]),h=c.useCallback(p=>{l(Number(p.target.value))},[]);return s.jsxs("div",{className:"contactSearchWrapper",children:[s.jsx("input",{placeholder:"Type here to search for contacts...",id:"searchbox",type:"text",value:o,onChange:m}),s.jsx("label",{htmlFor:"pagesizebox",children:"Page "}),s.jsx("input",{id:"pagebox",onChange:h,value:r,type:"number",min:"1",max:a})]})});v.displayName="ContactSearch";function F(){H();const[n,t]=c.useState(""),[a,o]=c.useState(1),[e,r]=c.useState(1),l=c.useMemo(()=>({setMaxPage:r}),[]);return s.jsxs(w.Provider,{value:l,children:[s.jsx(v,{onSearchChange:t,onPageChange:o,maxPage:e}),n&&s.jsx(P,{searchTerm:n,page:a})]})}const Z="0.4.1";function K(){return s.jsxs("div",{className:"mainContainer",children:[s.jsx(F,{}),s.jsxs("span",{id:"version-tag",children:["Version: ",Z]})]})}O(document.getElementById("root")).render(s.jsx(c.StrictMode,{children:s.jsx(K,{})}));
